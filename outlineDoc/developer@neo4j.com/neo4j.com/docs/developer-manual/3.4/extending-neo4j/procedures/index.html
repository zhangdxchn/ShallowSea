
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta charset="utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
      <title>6.1.&nbsp;Procedures - Chapter&nbsp;6.&nbsp;Extending Neo4j</title>
      <link rel="stylesheet" type="text/css" href="../../docbook.css"></link>
      <link rel="stylesheet" type="text/css" href="../../../../../../maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"></link>
      <link rel="stylesheet" type="text/css" href="../../../../../../cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css"></link>
      <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,400italic,600,300italic"></link>
      <link rel="stylesheet" type="text/css" href="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/codemirror.min.css"></link>
      <link rel="stylesheet" type="text/css" href="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/theme/neo.min.css"></link>
      <link rel="stylesheet" type="text/css" href="../../css/extra.css"></link>
      <link rel="stylesheet" type="text/css" href="../../css/chunked-base.css"></link>
      <link rel="stylesheet" type="text/css" href="../../css/console.css"></link><script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js" type="text/javascript"></script><script src="../../../../../../maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/codemirror.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/addon/runmode/runmode.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/mode/javascript/javascript.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/mode/shell/shell.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/mode/python/python.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/mode/xml/xml.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/mode/clike/clike.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/mode/cypher/cypher.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/mode/properties/properties.min.js" type="text/javascript"></script><script src="../../../../../../cdnjs.cloudflare.com/ajax/libs/codemirror/5.36.0/mode/groovy/groovy.min.js" type="text/javascript"></script><script src="../../javascript/colorize.js" type="text/javascript"></script><script src="../../javascript/tabs-for-chunked.js" type="text/javascript"></script><script src="../../javascript/mp-nav.js" type="text/javascript"></script><script src="../../javascript/versionswitcher.js" type="text/javascript"></script><script src="../../javascript/version.js" type="text/javascript"></script><script src="https://s3-eu-west-1.amazonaws.com/alpha.neohq.net/docs/new-manual/assets/search.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"></meta>
      <meta name="description" content="User-defined procedures are written in Java, deployed into the database, and called from Cypher."></meta>
      <link rel="prev" href="../index.html" title="Chapter&nbsp;6.&nbsp;Extending Neo4j"></link>
      <link rel="next" href="../cypher-functions/index.html" title="6.2.&nbsp;User-defined functions"></link>
      <link rel="shortcut icon" href="../../../../../wp-content/themes/neo4jweb/favicon.ico"></link><script>
        $(document).ready(function() {
          CodeMirror.colorize();
          tabTheSource($('body'));
          var $header = $('header').first();
          $header.prepend(
            $('<a href="../../index.html" id="logo"><img src="../../../../../wp-content/themes/neo4jweb/assets/images/neo4j-logo-2015.png" alt="Neo4j Logo"></img></a>')
          );
          var $sidebar = $('<div id="sidebar-wrapper"></div>');
          $.get('toc.html', function (d){
            $(d).appendTo($sidebar);
            highlightToc();
            highlightLibraryHeader();
          });
          $sidebar.insertAfter($('header').first());
        });
        </script></head>
   <body>
      <header>
         <div class="searchbox">
            <form id="search-form" class="search" name="search-form" role="search"><input id="search-form-input" name="q" title="search" type="search" lang="en" placeholder="Search Neo4j docs..." aria-label="Search Neo4j documentation" max-length="128" required="required"></input><input id="search-form-button" type="submit" value="Search"></input></form>
         </div>
         <ul class="documentation-library">
            <li><a href="https://neo4j.com/docs/operations-manual/3.4/">Operations Manual</a></li>
            <li><a href="../../index.html">Developer Manual</a></li>
            <li><a href="https://neo4j.com/docs/ogm-manual/3.0/">OGM Manual</a></li>
            <li><a href="https://neo4j.com/docs/graph-algorithms/3.4/">Graph Algorithms</a></li>
            <li><a href="https://neo4j.com/docs/java-reference/3.4/">Java Reference</a></li>
         </ul>
         <nav id="header-nav"><span class="nav-previous"><a accesskey="p" href="../index.html"><span class="fa fa-long-arrow-left" aria-hidden="true"></span>Extending Neo4j</a></span><span class="nav-current">
               <p class="nav-title hidden">6.1.&nbsp;Procedures</p></span><span class="nav-next"><a accesskey="n" href="../cypher-functions/index.html">User-defined functions<span class="fa fa-long-arrow-right" aria-hidden="true"></span></a></span></nav>
      </header>
      <div id="search-results" class="hidden"></div>
      <section class="section" id="procedures">
         <div class="titlepage">
            <div>
               <div>
                  <h2 class="title" style="clear: both"><a class="anchor" href="index.html#procedures"></a>6.1.&nbsp;Procedures
                  </h2>
               </div>
            </div>
         </div>
         <div class="abstract">
            <p>User-defined procedures are written in Java, deployed into the database, and called from Cypher.</p>
         </div>
         <p>A <span class="emphasis"><em>procedure</em></span> is a mechanism that allows Neo4j to be extended by writing custom code which can be invoked directly from Cypher.
            Procedures can take arguments, perform operations on the database, and return results.
         </p>
         <p>Procedures are written in Java and compiled into <span class="emphasis"><em>jar</em></span> files.
            They can be deployed to the database by dropping a <span class="emphasis"><em>jar</em></span> file into the <span class="emphasis"><em>$NEO4J_HOME/plugins</em></span> directory on each standalone or clustered server.
            The database must be re-started on each server to pick up new procedures.
         </p>
         <p>Procedures are the preferred means for extending Neo4j.
            Examples of use cases for procedures are:
         </p>
         <div class="orderedlist">
            <ol class="orderedlist" type="1">
               <li class="listitem">To provide access to functionality that is not available in Cypher.</li>
               <li class="listitem">To provide access to third party systems.</li>
               <li class="listitem">To perform graph-global operations, such as counting connected components or finding dense nodes.</li>
               <li class="listitem">To express a procedural operation that is difficult to express declaratively with Cypher.</li>
            </ol>
         </div>
         <section class="section" id="call-procedure">
            <div class="titlepage">
               <div>
                  <div>
                     <h3 class="title"><a class="anchor" href="index.html#call-procedure"></a>6.1.1.&nbsp;Calling procedures
                     </h3>
                  </div>
               </div>
            </div>
            <p>To call a stored procedure, use a Cypher <code class="literal">CALL</code> clause.
               The procedure name must be fully qualified, so a procedure named <code class="literal">findDenseNodes</code> defined in the package <code class="literal">org.neo4j.examples</code> could be called using:
            </p><pre class="programlisting highlight"><code data-lang="cypher">CALL org.neo4j.examples.findDenseNodes(1000)</code></pre><p>A <code class="literal">CALL</code> may be the only clause within a Cypher statement or may be combined with other clauses.
               Arguments can be supplied directly within the query or taken from the associated parameter set.
               For full details, see the Cypher documentation on <a class="link" href="../../cypher/clauses/call/index.html" title="3.3.17.&nbsp;CALL[&#8230;&#8203;YIELD]">the <code class="literal">CALL</code> clause.</a></p>
         </section>
         <section class="section" id="built-in-procedures">
            <div class="titlepage">
               <div>
                  <div>
                     <h3 class="title"><a class="anchor" href="index.html#built-in-procedures"></a>6.1.2.&nbsp;Built-in procedures
                     </h3>
                  </div>
               </div>
            </div>
            <p>Neo4j comes bundled with a number of built-in procedures.
               These can be used to:
            </p>
            <div class="itemizedlist">
               <ul class="itemizedlist" style="list-style-type: disc; ">
                  <li class="listitem">Inspect schema.</li>
                  <li class="listitem">Inspect meta data.</li>
                  <li class="listitem">Explore procedures and components.</li>
                  <li class="listitem">Monitor management data.</li>
                  <li class="listitem">Set user password.</li>
               </ul>
            </div>
            <p>A subset of these are described in <a href="https://neo4j.com/docs/operations-manual/3.4/reference/procedures/" class="olink">Operations Manual &#8594; Built-in procedures</a>.
               Running <code class="literal">CALL dbms.procedures()</code> will display the full list of all the procedures.
            </p>
         </section>
         <section class="section" id="user-defined-procedures">
            <div class="titlepage">
               <div>
                  <div>
                     <h3 class="title"><a class="anchor" href="index.html#user-defined-procedures"></a>6.1.3.&nbsp;User-defined procedures
                     </h3>
                  </div>
               </div>
            </div>
            <div class="abstract">
               <p>This section covers how to write, test and deploy a procedure for Neo4j.</p>
            </div>
            <p>Custom procedures are written in the Java programming language.
               Procedures are deployed via a <span class="emphasis"><em>jar</em></span> file that contains the code itself along with any dependencies (excluding Neo4j).
               These files should be placed into the <span class="emphasis"><em>plugin</em></span> directory of each standalone database or cluster member and will become available following the next database restart.
            </p>
            <p>The example that follows shows the steps to create and deploy a new procedure.</p>
            <div class="admonitionblock tip">
               <table>
                  <tbody>
                     <tr>
                        <td class="icon"><i class="fa icon-tip" title="tip"></i></td>
                        <td class="content">
                           <p>The example discussed below is available as <a class="link" href="https://github.com/neo4j-examples/neo4j-procedure-template" target="_top">a repository on GitHub</a>.
                              To get started quickly you can fork the repository and work with the code as you follow along in the guide below.
                           </p>
                        </td>
                     </tr>
                  </tbody>
               </table>
            </div>
            <section class="section" id="_set_up_a_new_project">
               <div class="titlepage">
                  <div>
                     <div>
                        <h4 class="title"><a class="anchor" href="index.html#_set_up_a_new_project"></a>6.1.3.1.&nbsp;Set up a new project
                        </h4>
                     </div>
                  </div>
               </div>
               <p>A project can be set up in any way that allows for compiling a procedure and producing a <span class="emphasis"><em>jar</em></span> file.
                  Below is an example configuration using the <a class="link" href="https://maven.apache.org/" target="_top">Maven</a> build system.
                  For readability, only excerpts from the Maven <span class="emphasis"><em>pom.xml</em></span> file are shown here, the whole file is available from the <a class="link" href="https://github.com/neo4j-examples/neo4j-procedure-template" target="_top">Neo4j Procedure Template</a> repository.
               </p>
               <p><span class="formalpara-title">Setting up a project with Maven.&nbsp;</span>
                  
               </p><pre class="programlisting highlight"><code data-lang="xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                     http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
 &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

 &lt;groupId&gt;org.neo4j.example&lt;/groupId&gt;
 &lt;artifactId&gt;procedure-template&lt;/artifactId&gt;
 &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;

 &lt;packaging&gt;jar&lt;/packaging&gt;
 &lt;name&gt;Neo4j Procedure Template&lt;/name&gt;
 &lt;description&gt;A template project for building a Neo4j Procedure&lt;/description&gt;

 &lt;properties&gt;
   &lt;neo4j.version&gt;3.4.14&lt;/neo4j.version&gt;
 &lt;/properties&gt;</code></pre><p>
                  
               </p>
               <p>Next, the build dependencies are defined.
                  The following two sections are included in the <span class="emphasis"><em>pom.xml</em></span> between <code class="literal">&lt;dependencies&gt;&lt;/dependencies&gt;</code> tags.
               </p>
               <p>The first dependency section includes the procedure API that procedures use at runtime.
                  The scope is set to <code class="literal">provided</code>, because once the procedure is deployed to a Neo4j instance, this dependency is provided by Neo4j.
                  If non-Neo4j dependencies are added to the project, their scope should normally be <code class="literal">compile</code>.
               </p><pre class="programlisting highlight"><code data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.neo4j&lt;/groupId&gt;
  &lt;artifactId&gt;neo4j&lt;/artifactId&gt;
  &lt;version&gt;${neo4j.version}&lt;/version&gt;
  &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;</code></pre><p>Next, the dependencies necessary for testing the procedure are added:</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem">Neo4j Harness, a utility that allows for starting a lightweight Neo4j instance.
                        It is used to start Neo4j with a specific procedure deployed, which greatly simplifies testing.
                     </li>
                     <li class="listitem">The Neo4j Java driver, used to send cypher statements that call the procedure.</li>
                     <li class="listitem">JUnit, a common Java test framework.</li>
                  </ul>
               </div><pre class="programlisting highlight"><code data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.neo4j.test&lt;/groupId&gt;
  &lt;artifactId&gt;neo4j-harness&lt;/artifactId&gt;
  &lt;version&gt;${neo4j.version}&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;org.neo4j.driver&lt;/groupId&gt;
  &lt;artifactId&gt;neo4j-java-driver&lt;/artifactId&gt;
  &lt;version&gt;1.6.3&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;junit&lt;/groupId&gt;
  &lt;artifactId&gt;junit&lt;/artifactId&gt;
  &lt;version&gt;4.12&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre><p>Along with declaring the dependencies used by the procedure it is also necessary to define the steps that Maven will go through
                  to build the project.
                  The goal is first to <span class="emphasis"><em>compile</em></span> the source, then to <span class="emphasis"><em>package</em></span> it in a <span class="emphasis"><em>jar</em></span> that can be deployed to a Neo4j instance.
               </p>
               <div class="admonitionblock note">
                  <table>
                     <tbody>
                        <tr>
                           <td class="icon"><i class="fa icon-note" title="note"></i></td>
                           <td class="content">
                              <p>Procedures require at least Java 8, so the version <code class="literal">1.8</code> should be defined as the <span class="emphasis"><em>source</em></span> and <span class="emphasis"><em>target version</em></span> in the configuration for the Maven compiler plugin.
                              </p>
                           </td>
                        </tr>
                     </tbody>
                  </table>
               </div>
               <p>The <a class="link" href="https://maven.apache.org/plugins/maven-shade-plugin/" target="_top">Maven Shade</a> plugin is used to package the compiled procedure.
                  It also includes all dependencies in the package, unless the dependency scope is set to <span class="emphasis"><em>test</em></span> or <span class="emphasis"><em>provided</em></span>.
               </p>
               <p>Once the procedure has been deployed to the <span class="emphasis"><em>plugins</em></span> directory of each Neo4j instance and the instances have restarted, the procedure is available for use.
               </p><pre class="programlisting highlight"><code data-lang="xml">&lt;build&gt;
 &lt;plugins&gt;
   &lt;plugin&gt;
     &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
     &lt;version&gt;3.1&lt;/version&gt;
     &lt;configuration&gt;
       &lt;source&gt;1.8&lt;/source&gt;
       &lt;target&gt;1.8&lt;/target&gt;
     &lt;/configuration&gt;
   &lt;/plugin&gt;
   &lt;plugin&gt;
     &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
     &lt;executions&gt;
       &lt;execution&gt;
         &lt;phase&gt;package&lt;/phase&gt;
         &lt;goals&gt;
           &lt;goal&gt;shade&lt;/goal&gt;
         &lt;/goals&gt;
       &lt;/execution&gt;
     &lt;/executions&gt;
   &lt;/plugin&gt;
 &lt;/plugins&gt;
&lt;/build&gt;</code></pre></section>
            <section class="section" id="_writing_integration_tests">
               <div class="titlepage">
                  <div>
                     <div>
                        <h4 class="title"><a class="anchor" href="index.html#_writing_integration_tests"></a>6.1.3.2.&nbsp;Writing integration tests
                        </h4>
                     </div>
                  </div>
               </div>
               <p>The test dependencies include <span class="emphasis"><em>Neo4j Harness</em></span> and <span class="emphasis"><em>JUnit</em></span>.
                  These can be used to write integration tests for procedures.
               </p>
               <p>First, we decide what the procedure should do, then we write a test that proves that it does it right.
                  Finally we write a procedure that passes the test.
               </p>
               <p>Below is a template for testing a procedure that accesses Neo4j&#8217;s full-text indexes from Cypher.</p>
               <p><span class="formalpara-title">Writing tests for procedures.&nbsp;</span>
                  
               </p><pre class="programlisting highlight"><code data-lang="java">package example;

import org.junit.Rule;
import org.junit.Test;
import org.neo4j.driver.v1.*;
import org.neo4j.graphdb.factory.GraphDatabaseSettings;
import org.neo4j.harness.junit.Neo4jRule;

import static org.hamcrest.core.IsEqual.equalTo;
import static org.junit.Assert.assertThat;
import static org.neo4j.driver.v1.Values.parameters;

public class ManualFullTextIndexTest
{
    // This rule starts a Neo4j instance
    @Rule
    public Neo4jRule neo4j = new Neo4jRule()

            // This is the Procedure we want to test
            .withProcedure( FullTextIndex.class );

    @Test
    public void shouldAllowIndexingAndFindingANode() throws Throwable
    {
        // In a try-block, to make sure we close the driver after the test
        try( Driver driver = GraphDatabase.driver( neo4j.boltURI() , Config.build().withoutEncryption().toConfig() ) )
        {

            // Given I've started Neo4j with the FullTextIndex procedure class
            //       which my 'neo4j' rule above does.
            Session session = driver.session();

            // And given I have a node in the database
            long nodeId = session.run( "CREATE (p:User {name:'Brookreson'}) RETURN id(p)" )
                    .single()
                    .get( 0 ).asLong();

            // When I use the index procedure to index a node
            session.run( "CALL example.index($id, ['name'])", parameters( "id", nodeId ) );

            // Then I can search for that node with lucene query syntax
            StatementResult result = session.run( "CALL example.search('User', 'name:Brook*')" );
            assertThat( result.single().get( "nodeId" ).asLong(), equalTo( nodeId ) );
        }
    }
}</code></pre><p>
                  
               </p>
            </section>
            <section class="section" id="writing-procedure">
               <div class="titlepage">
                  <div>
                     <div>
                        <h4 class="title"><a class="anchor" href="index.html#writing-procedure"></a>6.1.3.3.&nbsp;Writing a procedure
                        </h4>
                     </div>
                  </div>
               </div>
               <p>With the test in place, we write a procedure procedure that fulfils the expectations of the test.
                  The full example is available in the <a class="link" href="https://github.com/neo4j-examples/neo4j-procedure-template" target="_top">Neo4j Procedure Template</a> repository.
               </p>
               <p>Particular things to note:</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem">All procedures are annotated <code class="literal">@Procedure</code>.
                     </li>
                     <li class="listitem">
                        <p class="simpara">The procedure annotation can take three optional arguments: <code class="literal">name</code>, <code class="literal">mode</code>, and <code class="literal">eager</code>.
                           Note that <code class="literal">eager</code> is only available in Neo4j 3.4.6 or later.
                        </p>
                        <div class="itemizedlist">
                           <ul class="itemizedlist" style="list-style-type: circle; ">
                              <li class="listitem"><code class="literal">name</code> is used to specify a different name for the procedure than the default generated, which is <code class="literal">class.path.nameOfMethod</code>.
                                 If <code class="literal">mode</code> is specified then <code class="literal">name</code> must be specified as well.
                              </li>
                              <li class="listitem">
                                 <p class="simpara"><code class="literal">mode</code> is used to declare the types of interactions that the procedure will perform.
                                    The default <code class="literal">mode</code> is <code class="literal">READ</code>.
                                    The following modes are available:
                                 </p>
                                 <div class="itemizedlist">
                                    <ul class="itemizedlist" style="list-style-type: square; ">
                                       <li class="listitem"><code class="literal">READ</code> This procedure will only perform read operations against the graph.
                                       </li>
                                       <li class="listitem"><code class="literal">WRITE</code> This procedure will perform read and write operations against the graph.
                                       </li>
                                       <li class="listitem"><code class="literal">SCHEMA</code> This procedure will perform operations against the schema, i.e. create and drop indexes and constraints.
                                          A procedure with this mode is able to read graph data, but not write.
                                       </li>
                                       <li class="listitem"><code class="literal">DBMS</code> This procedure will perform system operations such as user management and query management.
                                          A procedure with this mode is not able to read or write graph data.
                                       </li>
                                    </ul>
                                 </div>
                              </li>
                              <li class="listitem">
                                 <p class="simpara"><code class="literal">eager</code> is a boolean setting defaulting to <code class="literal">false</code>.
                                    If it is set to <code class="literal">true</code> then the Cypher planner will plan an extra <code class="literal">Eager</code> operation before calling the procedure.
                                    This is useful in cases where the procedure makes changes to the database in a way that could interact with the operations
                                    preceding the procedure.
                                    For example:
                                 </p><pre class="programlisting highlight"><code data-lang="cypher">MATCH (n)
WHERE n.key = 'value'
WITH n
CALL deleteNeighbours(n, 'FOLLOWS')`</code></pre><p class="simpara">This query could delete some of the nodes that would be matched by the Cypher query, and then the <code class="literal">n.key</code> lookup will fail.
                                    Marking this procedure as <code class="literal">eager</code> will prevent this from causing an error in Cypher code.
                                    However, it is still possible for the procedure to interfere with itself by trying to read entities it has previously deleted.
                                    It is the responsibility of the procedure author to handle that case.
                                 </p>
                              </li>
                           </ul>
                        </div>
                     </li>
                     <li class="listitem">The <span class="emphasis"><em>context</em></span> of the procedure, which is the same as each resource that the procedure wants to use, is annotated <code class="literal">@Context</code>.
                     </li>
                     <li class="listitem">
                        <p class="simpara">The following can be noted about types:</p>
                        <div class="itemizedlist">
                           <ul class="itemizedlist" style="list-style-type: circle; ">
                              <li class="listitem">The <span class="emphasis"><em>input</em></span> and <span class="emphasis"><em>output</em></span> to and from a procedure must be one of the supported types, as described in <a class="xref" href="../../cypher/syntax/values/index.html" title="3.2.1.&nbsp;Values and types">Section&nbsp;3.2.1, &#8220;Values and types&#8221;</a>.
                              </li>
                              <li class="listitem">The Cypher types and their equivalents in Java are outlined in <a class="link" href="index.html#writing-procedure-types" title="Table&nbsp;6.1.&nbsp;Supported types">the table below</a>.
                              </li>
                              <li class="listitem">
                                 <p class="simpara">Composite types are also supported via:</p>
                                 <div class="itemizedlist">
                                    <ul class="itemizedlist" style="list-style-type: square; ">
                                       <li class="listitem"><code class="literal">List&lt;T&gt;</code>, where <code class="literal">T</code> is one the supported types, and
                                       </li>
                                       <li class="listitem"><code class="literal">Map&lt;String, Object&gt;</code>, where the values in the map must have one of the supported types.
                                       </li>
                                    </ul>
                                 </div>
                              </li>
                              <li class="listitem">The use of <code class="literal">Object</code> is supported for the case where the type is not known beforehand.
                                 Note, however, that the actual value must still have one of the aforementioned types.
                              </li>
                           </ul>
                        </div>
                     </li>
                  </ul>
               </div>
               <div class="table" id="writing-procedure-types">
                  <table class="table" summary="Supported types" border="1">
                     <caption class="table-title">Table&nbsp;6.1.&nbsp;Supported types</caption>
                     <colgroup>
                        <col class="col_1"></col>
                        <col class="col_2"></col>
                     </colgroup>
                     <thead>
                        <tr>
                           <th style="text-align: left; vertical-align: top; ">Cypher type</th>
                           <th style="text-align: left; vertical-align: top; ">Java type</th>
                        </tr>
                     </thead>
                     <tbody>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">String</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">String</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Integer</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Long</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Float</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Double</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Boolean</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Boolean</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Point</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">org.neo4j.graphdb.spatial.Point</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Date</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">java.time.LocalDate</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Time</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">java.time.OffsetTime</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">LocalTime</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">java.time.LocalTime</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">DateTime</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">java.time.ZonedDateTime</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">LocalDateTime</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">java.time.LocalDateTime</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Duration</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">java.time.temporal.TemporalAmount</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Node</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">org.neo4j.graphdb.Node</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Relationship</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">org.neo4j.graphdb.Relationship</code></p>
                           </td>
                        </tr>
                        <tr>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">Path</code></p>
                           </td>
                           <td style="text-align: left; vertical-align: top; ">
                              <p><code class="literal">org.neo4j.graphdb.Path</code></p>
                           </td>
                        </tr>
                     </tbody>
                  </table>
               </div>
               <p>For more details, see the <a class="link" href="https://neo4j.com/docs/java-reference/3.4/javadocs/index.html?org/neo4j/procedure/Procedure.html" target="_top">API documentation for procedures</a>.
               </p>
               <p>Take note that there are two cases where more than one Java type is mapped to a single Cypher type.
                  When this happens, type information is lost.
                  If these objects are returned from procedures, the original types cannot be recreated:
               </p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem">A Cypher <code class="literal">Duration</code> is created when either a <code class="literal">java.time.Duration</code> or a <code class="literal">java.time.Period</code> is provided.
                        If a <code class="literal">Duration</code> is returned, only the common interface <code class="literal">java.time.temporal.TemporalAmount</code> will remain.
                     </li>
                     <li class="listitem">A Cypher <code class="literal">DateTime</code> is created when a <code class="literal">java.time.OffsetDateTime</code> is provided.
                        If a <code class="literal">DateTime</code> is returned, it will be converted into a <code class="literal">java.time.ZonedDateTime</code>.
                     </li>
                  </ul>
               </div>
               <div class="admonitionblock note">
                  <table>
                     <tbody>
                        <tr>
                           <td class="icon"><i class="fa icon-note" title="note"></i></td>
                           <td class="content">
                              <p>The correct way to signal an error from within a procedure is to throw a <code class="literal">RuntimeException</code>.
                              </p>
                           </td>
                        </tr>
                     </tbody>
                  </table>
               </div><pre class="programlisting highlight"><code data-lang="java">package example;

import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Stream;

import org.neo4j.graphdb.GraphDatabaseService;
import org.neo4j.graphdb.Label;
import org.neo4j.graphdb.Node;
import org.neo4j.graphdb.index.Index;
import org.neo4j.graphdb.index.IndexManager;
import org.neo4j.logging.Log;
import org.neo4j.procedure.Context;
import org.neo4j.procedure.Name;
import org.neo4j.procedure.PerformsWrites;
import org.neo4j.procedure.Procedure;

import static org.neo4j.helpers.collection.MapUtil.stringMap;
import static org.neo4j.procedure.Procedure.Mode.SCHEMA;
import static org.neo4j.procedure.Procedure.Mode.WRITE;

/**
 * This is an example showing how you could expose Neo4j's full-text indexes as
 * two procedures - one for updating indexes, and one for querying by label and
 * the lucene query language.
 */
public class FullTextIndex
{
    // Only static fields and @Context-annotated fields are allowed in
    // Procedure classes. This static field is the configuration we use
    // to create full-text indexes.
    private static final Map&lt;String,String&gt; FULL_TEXT =
            stringMap( IndexManager.PROVIDER, "lucene", "type", "fulltext" );

    // This field declares that we need a GraphDatabaseService
    // as context when any procedure in this class is invoked
    @Context
    public GraphDatabaseService db;

    // This gives us a log instance that outputs messages to the
    // standard log, `neo4j.log`
    @Context
    public Log log;

    /**
     * This declares the first of two procedures in this class - a
     * procedure that performs queries in a manual index.
     *
     * It returns a Stream of Records, where records are
     * specified per procedure. This particular procedure returns
     * a stream of {@link SearchHit} records.
     *
     * The arguments to this procedure are annotated with the
     * {@link Name} annotation and define the position, name
     * and type of arguments required to invoke this procedure.
     * There is a limited set of types you can use for arguments,
     * these are as follows:
     *
     * &lt;ul&gt;
     *     &lt;li&gt;{@link String}&lt;/li&gt;
     *     &lt;li&gt;{@link Long} or {@code long}&lt;/li&gt;
     *     &lt;li&gt;{@link Double} or {@code double}&lt;/li&gt;
     *     &lt;li&gt;{@link Number}&lt;/li&gt;
     *     &lt;li&gt;{@link Boolean} or {@code boolean}&lt;/li&gt;
     *     &lt;li&gt;{@link org.neo4j.graphdb.Node}&lt;/li&gt;
     *     &lt;li&gt;{@link org.neo4j.graphdb.Relationship}&lt;/li&gt;
     *     &lt;li&gt;{@link org.neo4j.graphdb.Path}&lt;/li&gt;
     *     &lt;li&gt;{@link java.util.Map} with key {@link String} and value of any type in this list, including {@link java.util.Map}&lt;/li&gt;
     *     &lt;li&gt;{@link java.util.List} of elements of any valid field type, including {@link java.util.List}&lt;/li&gt;
     *     &lt;li&gt;{@link Object}, meaning any of the types above&lt;/li&gt;
     *
     * @param label the label name to query by
     * @param query the lucene query, for instance `name:Brook*` to
     *              search by property `name` and find any value starting
     *              with `Brook`. Please refer to the Lucene Query Parser
     *              documentation for full available syntax.
     * @return the nodes found by the query
     */
    @Procedure( name = "example.search", mode = WRITE )
    public Stream&lt;SearchHit&gt; search( @Name("label") String label,
                                     @Name("query") String query )
    {
        String index = indexName( label );

        // Avoid creating the index, if it's not there we won't be
        // finding anything anyway!
        if( !db.index().existsForNodes( index ))
        {
            // Just to show how you'd do logging
            log.debug( "Skipping index query since index does not exist: `%s`", index );
            return Stream.empty();
        }

        // If there is an index, do a lookup and convert the result
        // to our output record.
        return db.index()
                .forNodes( index )
                .query( query )
                .stream()
                .map( SearchHit::new );
    }

    /**
     * This is the second procedure defined in this class, it is used to update the
     * index with nodes that should be queryable. You can send the same node multiple
     * times, if it already exists in the index the index will be updated to match
     * the current state of the node.
     *
     * This procedure works largely the same as {@link #search(String, String)},
     * with three notable differences. One, it is annotated with `mode = SCHEMA`,
     * which is &lt;i&gt;required&lt;/i&gt; if you want to perform updates to the graph in your
     * procedure.
     *
     * Two, it returns {@code void} rather than a stream. This is simply a short-hand
     * for saying our procedure always returns an empty stream of empty records.
     *
     * Three, it uses a default value for the property list, in this way you can call
     * the procedure by simply invoking {@code CALL index(nodeId)}. Default values are
     * are provided as the Cypher string representation of the given type, e.g.
     * {@code {default: true}}, {@code null}, or {@code -1}.
     *
     * @param nodeId the id of the node to index
     * @param propKeys a list of property keys to index, only the ones the node
     *                 actually contains will be added
     */
    @Procedure( name = "example.index", mode = SCHEMA )
    public void index( @Name("nodeId") long nodeId,
                       @Name(value = "properties", defaultValue = "[]") List&lt;String&gt; propKeys )
    {
        Node node = db.getNodeById( nodeId );

        // Load all properties for the node once and in bulk,
        // the resulting set will only contain those properties in `propKeys`
        // that the node actually contains.
        Set&lt;Map.Entry&lt;String,Object&gt;&gt; properties =
                node.getProperties( propKeys.toArray( new String[0] ) ).entrySet();

        // Index every label (this is just as an example, we could filter which labels to index)
        for ( Label label : node.getLabels() )
        {
            Index&lt;Node&gt; index = db.index().forNodes( indexName( label.name() ), FULL_TEXT );

            // In case the node is indexed before, remove all occurrences of it so
            // we don't get old or duplicated data
            index.remove( node );

            // And then index all the properties
            for ( Map.Entry&lt;String,Object&gt; property : properties )
            {
                index.add( node, property.getKey(), property.getValue() );
            }
        }
    }


    /**
     * This is the output record for our search procedure. All procedures
     * that return results return them as a Stream of Records, where the
     * records are defined like this one - customized to fit what the procedure
     * is returning.
     *
     * The fields must be one of the following types:
     *
     * &lt;ul&gt;
     *     &lt;li&gt;{@link String}&lt;/li&gt;
     *     &lt;li&gt;{@link Long} or {@code long}&lt;/li&gt;
     *     &lt;li&gt;{@link Double} or {@code double}&lt;/li&gt;
     *     &lt;li&gt;{@link Number}&lt;/li&gt;
     *     &lt;li&gt;{@link Boolean} or {@code boolean}&lt;/li&gt;
     *     &lt;li&gt;{@link org.neo4j.graphdb.Node}&lt;/li&gt;
     *     &lt;li&gt;{@link org.neo4j.graphdb.Relationship}&lt;/li&gt;
     *     &lt;li&gt;{@link org.neo4j.graphdb.Path}&lt;/li&gt;
     *     &lt;li&gt;{@link java.util.Map} with key {@link String} and value {@link Object}&lt;/li&gt;
     *     &lt;li&gt;{@link java.util.List} of elements of any valid field type, including {@link java.util.List}&lt;/li&gt;
     *     &lt;li&gt;{@link Object}, meaning any of the valid field types&lt;/li&gt;
     * &lt;/ul&gt;
     */
    public static class SearchHit
    {
        // This records contain a single field named 'nodeId'
        public long nodeId;

        public SearchHit( Node node )
        {
            this.nodeId = node.getId();
        }
    }

    private String indexName( String label )
    {
        return "label-" + label;
    }
}</code></pre></section>
            <section class="section" id="injectable-resources">
               <div class="titlepage">
                  <div>
                     <div>
                        <h4 class="title"><a class="anchor" href="index.html#injectable-resources"></a>6.1.3.4.&nbsp;Injectable resources
                        </h4>
                     </div>
                  </div>
               </div>
               <p>When writing procedures, some resources can be injected into the procedure from the database.
                  To inject these, use the <code class="literal">@Context</code> annotation.
                  The classes that can be injected are:
               </p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                     <li class="listitem"><code class="literal">Log</code></li>
                     <li class="listitem"><code class="literal">TerminationGuard</code></li>
                     <li class="listitem"><code class="literal">GraphDatabaseService</code></li>
                  </ul>
               </div>
               <p>All of the above classes are considered safe and future-proof, and will not compromise the security of the database.
                  There are also several classes that can be injected that are unsupported restricted and can be changed with little or no notice.
                  The database will not load all classes by default but can be toggled with <code class="literal">dbms.security.procedures.unrestricted</code> to load unsafe procedures.
               </p>
            </section>
         </section>
      </section>
      <footer><script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
          //Allow Linker
          ga('create', 'UA-1192232-34','auto', {'allowLinker': true});
          ga('send', 'pageview');
          // Load the plugin.
          ga('require', 'linker');
          // Define which domains to autoLink.
          ga('linker:autoLink', ['neo4j.org','neo4j.com','neotechnology.com','graphdatabases.com','graphconnect.com']);
        </script><script type="text/javascript">
          document.write(unescape("%3Cscript src='//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
        </script><script>Munchkin.init('773-GON-065');</script></footer>
   </body>
</html>